name: Deploy on Truefoundry
on:
  push:
    branches:
      - main

env:
  TFY_API_KEY: ${{ secrets.TFY_API_KEY }}
  TFY_HOST: https://app.truefoundry.com

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Check out repository code
        uses: actions/checkout@v3
      - run: echo "Deploying ${{ github.ref }} to servicefoundry"
      - name: Fetch manifest
        id: curl
        run: |
          curl --location --request GET https://app.truefoundry.com/api/svc/v1/app/clk8a3v5c1aga1hvv5jlff53u/manifest --header 'authorization: Bearer ${{ env.TFY_API_KEY }}' > tfy-manifest.json
      - name: editing SHA
        run: cat "tfy-manifest.json" | jq --arg sha "${{ github.sha }}" '.image.build_source.ref |= $sha' > new-tfy-manifest.json
      - name: Generate servicefoundry-patched.yaml
        run: cat "new-tfy-manifest.json" | yq -P > servicefoundry-patched.yaml
      - name: Install servicefoundry
        run: pip install servicefoundry
      - name: Deploy
        run: sfy deploy --workspace-fqn ctl-demo:l4-test --file servicefoundry-patched.yaml